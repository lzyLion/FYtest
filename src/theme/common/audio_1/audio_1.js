/*!2015-12-24 component*/
define(["underscore","zepto"],function(a,b){var c={init:function(c){a.isUndefined(c)&&(c=b("#mainaudio")),this.audioNode=c,window.wow_audio_node=this.audioNode,b("body").on("wfn_start_run",a.bind(this.onStartRun,this)),this._audio=new Audio,window.wow_audio=this._audio,this._isplaying=!1,this._handflip=!0,this._pausebyclick=!1,this.timer_txt=null,this._customAudioPlaying=!1,this._customAudioPlayed=!1,this._pageIndex=-1,this._customAudioPageIndex=-1,this._hasCustomAudio=!1,this._isStopByVoiceTag=!1,this.txt_controller=this.audioNode.find("#txt_controller"),b(this._audio).on("play",a.bind(this.onAudioPlay,this)),b(this._audio).on("pause",a.bind(this.onAudioPause,this)),this.audioNode.on("click",a.bind(this.onBtnFlipClicked,this)),this.audioNode.on("on_wow_click",a.bind(this.onBtnFlipClicked,this)),b(this._audio).on("ended",a.bind(this.loopKeeper,this));var d=this.audioNode.attr("data-ws_src");this.configAudio(d),this.initCustomAudio(),this.initVoiceTagProcess(),this.initPageChangeProcess()},loopKeeper:function(){this._audio.currentTime=0,this._audio.play()},run:function(){this._audio&&(this.audioNode.removeClass("wb_hidden"),this.audioPlayerKeeperRunned=!1,this.play())},onStartRun:function(){this.run()},onBtnFlipClicked:function(){this._handflip=!0,this.flip()},onAudioPlay:function(){this._handflip&&(this.audio_txt(this.txt_controller,!0,this.timer_txt),b("#btn_audio2").removeClass("audio_stop"),b("#btn_audio2").addClass("audio_play"),this._handflip=!1,this._pausebyclick=!1),this.audioPlayerKeeperRunned=!0},onAudioPause:function(){this._handflip&&(this.audio_txt(this.txt_controller,!1,this.timer_txt),b("#btn_audio2").removeClass("audio_play"),b("#btn_audio2").addClass("audio_stop"),this._handflip=!1,this._pausebyclick=!0)},audio_txt:function(a,b,c){b?a.text("打开"):a.text("关闭"),c&&clearTimeout(c),a.removeClass("z-move z-hide"),c=setTimeout(function(){a.addClass("z-move").addClass("z-hide")},1e3)},flip:function(){this._isplaying?(this._isStopByVoiceTag=!1,this.stop()):this.play()},play:function(){this._audio?(this._audio.play(),b(window).trigger("on_wow_audio_comp_play"),window.wow_audio_playing=!0,this._isplaying=!0):this._isplaying=!1},stop:function(){this._audio&&(this._audio.pause(),b(window).trigger("on_wow_audio_comp_stop"),window.wow_audio_playing=!1,this._isplaying=!1)},playerKeeper:function(){this.audioPlayerKeeperRunned||this._isplaying&&null!=this._audio&&(this._handflip=!0,this.play())},initCustomAudio:function(){var c=b("#w_customaudio_0");if(0!=c.length){this._hasCustomAudio=!0;var d=JSON.parse(c.attr("data-wb_set_custom_audio"));if(!a.isUndefined(d)){a.isUndefined(d.pageIndex)?this._customAudioPageIndex=-1:this._customAudioPageIndex=d.pageIndex;var e=c.attr("data-ws_src");return void(this._customAudioSrc=e)}}},configAudio:function(c){var d={loop:!1,preload:"auto",src:c,"ke-src":c};a.extend(this._audio,d),b(this._audio).attr("data-src",c),b(this._audio).attr("data-ke-src",c)},setPageIndex:function(c){this._pageIndex=c;var d=this;this._customAudioPageIndex==c&&(this._customAudioPlaying||this._customAudioPlayed||this._isplaying&&(this._audio.pause(),this.curBGAudioTime=this._audio.currentTime,setTimeout(function(){var c=d._audio.currentSrc;d.configAudio(d._customAudioSrc),d._customAudioPlaying=!0,b(d._audio).on("ended",function(){d._customAudioPlayed=!0,d._customAudioPlaying=!1,d.configAudio(c),b(d._audio).off("ended"),b(d._audio).on("ended",a.bind(d.loopKeeper,d)),b(d._audio).on("durationchange",function(){d._audio.duration>0&&(d._audio.currentTime=d.curBGAudioTime,d._audio.muted=!1,b(d._audio).off("durationchange"))}),d._audio.play(),d._audio.muted=!0}),d._audio.play()},100)))},processCustomAudio:function(c){var d=this;if(c.find(".custom_audio").length>0){var e;e=b(c.find(".custom_audio")[0]);var f=JSON.parse(e.attr("data-wb_set_custom_audio"));if(a.isUndefined(f))return;var g=e.attr("data-ws_src");if(this._customAudioPlaying)return;if(this._customAudioPlayed)return;this._isplaying&&(this._audio.pause(),this.curBGAudioTime=this._audio.currentTime,setTimeout(function(){var c=d._audio.currentSrc;d.configAudio(g),d._customAudioPlaying=!0,b(d._audio).on("ended",function(){d._customAudioPlayed=!0,d._customAudioPlaying=!1,d.configAudio(c),b(d._audio).off("ended"),b(d._audio).on("ended",a.bind(d.loopKeeper,d)),b(d._audio).on("durationchange",function(){d._audio.duration>0&&(d._audio.currentTime=d.curBGAudioTime,d._audio.muted=!1,b(d._audio).off("durationchange"))}),d._audio.play(),d._audio.muted=!0}),d._audio.play()},100))}},initPageChangeProcess:function(){var c=this;b(window).on("on_wow_pageChanged",function(d,e){a.isUndefined(e)||c.processCustomAudio(b(e))})},initVoiceTagProcess:function(){var a=this;b(window).on("on_wow_voice_label_play",function(c,d){a._isplaying&&(a._isplaying=!1,a._isStopByVoiceTag=!0,b("#btn_audio2").removeClass("audio_play"),a.stop())}),b(window).on("on_wow_voice_label_stop",function(c,d){a._isStopByVoiceTag&&(a._isStopByVoiceTag=!1,b("#btn_audio2").addClass("audio_play"),a.play())})}};return c});